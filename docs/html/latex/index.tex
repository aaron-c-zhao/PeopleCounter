\section*{People counter}

this repo consist of 2 main parts, the people counting module and the test harness to run it. The poeplecounter module in peoplecounter.\+c is supposed to be hardware independent and really to be implemented on an embedded system. Because the team didn\textquotesingle{}t have access to the hardware and firmware to test the module, a testing harness was created. This harness will go through recorded sensor data in ./data and call the module on each frame, according to the api. This way we could test and improve the pipeline.

\subsection*{Documentation}

For documenting the code in this repo doxygen was used. This generated interactive html documentation. The generated html can be found in \char`\"{}./docs/html/html/index.\+html\char`\"{}. This can also be regenerated by running the doxygen command in the root folder.

\section*{P\+E\+O\+P\+LE C\+O\+U\+N\+T\+ER IP P\+I\+P\+E\+L\+I\+NE T\+E\+S\+T\+I\+NG H\+A\+R\+N\+E\+SS}

This program was made to run and test the image processing pipeline of the people counter project.

\subsection*{H\+OW TO I\+N\+S\+T\+A\+LL A\+ND R\+UN T\+HE H\+A\+R\+N\+E\+SS}

\subsubsection*{S\+U\+P\+P\+O\+R\+T\+ED E\+N\+V\+I\+R\+O\+N\+M\+E\+NT}


\begin{DoxyItemize}
\item Mac Darwin
\item Linux
\end{DoxyItemize}

\subsubsection*{D\+E\+P\+E\+N\+D\+E\+N\+C\+I\+ES}


\begin{DoxyEnumerate}
\item C\+Make\+: $>$ 3.\+15
\item Open\+CV
\end{DoxyEnumerate}
\begin{DoxyItemize}
\item G\+CC 4.\+4.\+x or later
\item Git
\item G\+T\+K+2.x or higher
\item pkg-\/config
\item Python2.\+6 or later
\item ffmpeg or libav development packages\+: libavcodec-\/dev, libavformat-\/dev, libswscale-\/dev
\end{DoxyItemize}
\begin{DoxyEnumerate}
\item Doxygen 1.\+8.\+15(optional)
\end{DoxyEnumerate}

\subsubsection*{I\+N\+S\+T\+R\+U\+C\+T\+I\+O\+NS}

\paragraph*{C\+O\+N\+F\+I\+G\+U\+R\+A\+T\+I\+ON}

After cloning this repository onto your local machine, first you need to configure the harness code and header file of the pipeline which could be accomplished by modify these two files\+:
\begin{DoxyItemize}
\item harness\+\_\+config.\+json
\begin{DoxyItemize}
\item parameters\+: the parameters of the ip pipeline that will affect its affectiveness
\begin{DoxyItemize}
\item kernel\+\_\+1\+: gaussian blur kernel 1, default value 5
\item threshold\+: the threshold applied when binarize the image, defaule value 32
\item max\+\_\+area\+: the maximum area of a blob that is allowed, used as a trigger of updating threshold to detect overly large blobs, default value 18
\end{DoxyItemize}
\item harness\+\_\+setup\+: configurations of the harness code, this won\textquotesingle{}t affect the pipeline
\begin{DoxyItemize}
\item width\+: image width which will affect the image shown in the window
\item height\+: image height which will affect the image shown in the window
\item llimit\+: the lower limit applied when map the floating point temperature figure to 8bit grey value
\item hlimit\+: the upper limit applied when map the floating point temperature figure to 8bit grey value
\item frame\+\_\+rate\+: the frame rate of the video, this combined with the F\+R\+A\+M\+E\+\_\+\+R\+A\+TE seeting in header\+\_\+config.\+txt will decide the step of the image pointer.
\end{DoxyItemize}
\end{DoxyItemize}
\item header\+\_\+config.\+txt
\begin{DoxyItemize}
\item S\+E\+N\+S\+O\+R\+\_\+\+I\+M\+A\+G\+E\+\_\+\+W\+I\+D\+TH\+: the width of the image to be processed by the pipeline, default value 32
\item S\+E\+N\+S\+O\+R\+\_\+\+I\+M\+A\+G\+E\+\_\+\+H\+E\+I\+G\+HT\+: the height of the image to be processed by the pipeline, default valut 24
\item F\+R\+A\+M\+E\+\_\+\+R\+A\+TE\+: the frame rate that the pipeline will work with.
\item R\+E\+C\+T\+S\+\_\+\+M\+A\+X\+\_\+\+S\+I\+ZE\+: the maximum array size of the rects array
\item Q\+U\+E\+U\+E\+\_\+\+S\+I\+ZE\+: the maximum array size of the queue for breach first search
\item C\+T\+\_\+\+M\+A\+X\+\_\+\+D\+I\+S\+A\+P\+P\+E\+A\+R\+ED\+: the maximum frames in which a blob is allowed to disappear, after that the B\+I\+D(blob id) will be reallocated
\item C\+T\+\_\+\+M\+A\+X\+\_\+\+D\+I\+S\+T\+A\+N\+CE\+: the maximum distance that a blob is allowed to jump between frames
\item T\+R\+A\+C\+K\+A\+B\+L\+E\+\_\+\+O\+B\+J\+E\+C\+T\+\_\+\+M\+A\+X\+\_\+\+S\+I\+ZE\+: the maximum number of blobs or people that the pipeline could trace at the same time
\end{DoxyItemize}
\end{DoxyItemize}

\paragraph*{R\+UN T\+HE P\+I\+P\+E\+L\+I\+NE L\+I\+NE}

If you agree with the current configuration, then you can run the pipeline by following the instructions below\+:
\begin{DoxyEnumerate}
\item change directory(cd) into the source folder of the project(People\+Counter/)
\item run the script make.\+sh(./make.sh)
\item cd into the build/ folder.
\item run the executable(\+People\+Counter) with the argument of the path of the json file(./\+People\+Counter ../data/mlx90640/vertical/.....)
\end{DoxyEnumerate}

\paragraph*{I\+N\+T\+E\+R\+A\+C\+T\+I\+ON W\+I\+TH T\+HE H\+A\+R\+N\+E\+SS}

The harness will run the pipeline while displaying the images frame by frame. Press any key to go to the next frame. Press Ctrl+C on the terminal to exit.

\paragraph*{O\+U\+T\+P\+UT OF T\+HE H\+A\+R\+N\+E\+SS}

The harness will output the following\+:
\begin{DoxyItemize}
\item list of currently tracked objects, including its ID, centroid position and disappeared frame count
\item current frame number
\item the number of people that went up and down in this frame
\item the estimate count of people in the room
\end{DoxyItemize}

\subsection*{R\+E\+C\+O\+M\+M\+A\+N\+D\+A\+T\+I\+O\+NS F\+OR F\+U\+R\+T\+H\+ER D\+E\+V\+E\+L\+O\+P\+I\+NG}

In \mbox{\hyperlink{tracking_research}{People tracking research}} and \mbox{\hyperlink{detection_research}{People detection research}} all the possible research that could still be done is listed.

\subsubsection*{C\+O\+DE O\+P\+T\+I\+M\+A\+Z\+A\+T\+I\+ON}


\begin{DoxyEnumerate}
\item Hardcode the LoG kernel For the sake of easy testing with new parameters, the LoG kernel is generated by the harness code each time with the kernel size that have been set. In the final product, it should be hardcoded into the pipeline to reduce the computation.
\item Use the inplace calculation The functions in the pipleline are designed to be able to do inplace calculations. So no extra data structure is needed other than the one that is passed in by the firmware. But now, for displaying the intermedia result, an extra log\+\_\+mat was introduced which should be replaced by the frame\+\_\+mat to reduce the space requirement.
\item Ohters During the processing of the image, each pixel will be iterated several times. But not all of the iterations are necessary, due to the time constraint, we can not optimize it to the optimal. So coners could be cut there.
\end{DoxyEnumerate}

\subsubsection*{A\+L\+G\+O\+R\+I\+T\+HM O\+P\+T\+I\+M\+A\+Z\+A\+T\+I\+ON}


\begin{DoxyEnumerate}
\item People detection The pipeline now using the Laplacian of Gaussian algorithm to extract and detect blobs which is twice efficient than the previous thresholding + border tracing. But algorithms like \href{./docs/watershed.pdf}{\texttt{ Watershed}}, and Gaussian mixture have the potential to be more efficient.
\item People tracking The algorithm currently being used to track blobs is the nearest neighbour method, which is a basic tracking method. More advanced methods like Kalman filter will be more robust than the current one. But on the other hand, the robustness comes with a price that it will add a considerable amount of complexity to the system.
\item Background substraction For now the pipeline takes the first frame as the background(\+In the final product, this should be the first frame of each time the device is waken up by the P\+I\+R). This way has a fatal flaw which is that it relays on the assumption that the Melexis sensor could be waken up early enough that there\textquotesingle{}s still no person in the F\+OV. To sovle this Eigen backgound, \href{./docs/people_detection.pdf}{\texttt{ Morphological background substraction}} might be worthwhile to look into. 
\end{DoxyEnumerate}